<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ—ºï¸ æ™ºèƒ½è·¯çº¿è§„åˆ’åŠ©æ‰‹ - AIé©±åŠ¨çš„å¤šé€”ç»ç‚¹å¯¼èˆª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #1f2933;
      min-height: 100vh;
      position: relative;
    }
    
    /* èƒŒæ™¯è£…é¥° */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(234, 88, 12, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .page { 
      max-width: 1080px; 
      margin: 0 auto; 
      padding: 32px 16px 40px;
      position: relative;
      z-index: 1;
    }
    @media (max-width: 768px) {
      .page { padding: 16px 12px 32px; }
      h1 { font-size: 24px; }
      .card { padding: 14px 16px; margin-bottom: 14px; }
      input { font-size: 16px; } /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
    }
    
    /* é¡µé¢æ ‡é¢˜ */
    h1 { 
      font-size: 32px; 
      margin-bottom: 8px;
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-align: center;
      padding: 8px 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .subtitle { 
      font-size: 14px; 
      color: #e0e7ff; 
      margin-bottom: 28px;
      text-align: center;
      font-weight: 400;
    }
    
    /* å¡ç‰‡æ ·å¼ */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px 22px;
      box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.1),
        0 2px 8px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 4px 12px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* æ¸å…¥åŠ¨ç”» */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: fadeIn 0.5s ease-out;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
    
    .row { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 12px; }
    .field { flex: 1 1 240px; min-width: 0; }
    
    label { 
      display: block; 
      font-size: 13px; 
      color: #4b5563; 
      margin-bottom: 6px;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    
    input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      background: #ffffff;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    input:focus {
      border-color: #667eea;
      box-shadow: 
        0 0 0 3px rgba(102, 126, 234, 0.15),
        0 4px 12px rgba(102, 126, 234, 0.1);
      background: #ffffff;
      transform: translateY(-1px);
    }
    
    input:hover:not(:focus) {
      border-color: #d1d5db;
    }
    
    button {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:disabled { 
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.6;
    }
    
    button:not(:disabled):hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    button:not(:disabled):active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    /* èŠå¤©ç•Œé¢æ ·å¼ */
    .chat-messages {
      max-height: 420px;
      overflow-y: auto;
      margin-bottom: 14px;
      padding: 12px;
      background: linear-gradient(135deg, #fafbff 0%, #f9fafb 100%);
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
    }
    
    .chat-message {
      margin-bottom: 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chat-message.user {
      flex-direction: row-reverse;
    }
    
    .chat-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.2s;
    }
    
    .chat-bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    
    .chat-message.user .chat-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-bottom-right-radius: 6px;
    }
    
    .chat-message.assistant .chat-bubble {
      background: #ffffff;
      color: #1f2937;
      border: 2px solid #e5e7eb;
      border-bottom-left-radius: 6px;
    }
    
    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chat-message.user .chat-avatar {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }
    
    .chat-message.assistant .chat-avatar {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    .chat-input-area {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border-radius: 24px;
      border: 2px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      background: #ffffff;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    .chat-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }
    
    .chat-send-btn {
      padding: 12px 24px;
      border-radius: 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }
    
    .chat-send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }
    
    .chat-send-btn:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.6;
    }
    
    .chat-keyword-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      font-size: 11px;
      font-weight: 600;
      margin-top: 6px;
      box-shadow: 0 2px 4px rgba(146, 64, 14, 0.1);
    }
    /* Sectionæ ‡é¢˜æ ·å¼ */
    .section-title { 
      font-size: 16px; 
      font-weight: 700; 
      margin-bottom: 8px;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 18px;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }
    
    .section-sub { 
      font-size: 13px; 
      color: #6b7280; 
      margin-bottom: 14px;
      line-height: 1.6;
    }
    .mono-box {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: #e5e7eb;
      border-radius: 12px;
      padding: 14px 16px;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mono-box::-webkit-scrollbar {
      width: 6px;
    }
    
    .mono-box::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .mono-box::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
    }
    
    .poi-detail {
      font-size: 14px;
      color: #111827;
    }
    
    .poi-card {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      padding: 16px;
      background: linear-gradient(135deg, #fafbff 0%, #ffffff 100%);
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      transition: all 0.3s;
    }
    
    .poi-card:hover {
      border-color: #667eea;
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.15);
      transform: translateY(-2px);
    }
    
    .poi-card-main {
      flex: 1;
      min-width: 0;
    }
    
    .poi-card h3 {
      margin: 0 0 6px;
      font-size: 17px;
      font-weight: 700;
      color: #1f2937;
      letter-spacing: -0.3px;
    }
    
    .poi-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .poi-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .poi-meta span + span::before {
      content: "â€¢";
      margin: 0 4px;
      color: #9ca3af;
    }
    
    .poi-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 16px;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #1e40af;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      border: 1px solid #bfdbfe;
    }
    .poi-info-line {
      margin: 4px 0;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .poi-info-label {
      color: #6b7280;
      margin-right: 4px;
      font-weight: 600;
    }
    
    .poi-photo {
      width: 110px;
      height: 82px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
    
    .poi-photo:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .poi-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s;
    }
    
    .poi-photo:hover img {
      transform: scale(1.1);
    }
    
    .poi-route-btn {
      margin-top: 10px;
      padding: 10px 18px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      transition: all 0.2s;
    }
    
    .poi-route-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    /* é€”ç»ç‚¹åˆ—è¡¨æ ·å¼ */
    .waypoint-list {
      margin-top: 14px;
    }
    
    .waypoint-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: linear-gradient(135deg, #fafbff 0%, #f9fafb 100%);
      border-radius: 12px;
      margin-bottom: 10px;
      border: 2px solid #e5e7eb;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      position: relative;
      overflow: hidden;
    }
    
    .waypoint-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .waypoint-item:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      border-color: #667eea;
      transform: translateX(4px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.15);
    }
    
    .waypoint-item:hover::before {
      opacity: 1;
    }
    
    .waypoint-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .waypoint-order {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .waypoint-name {
      font-size: 15px;
      color: #1f2937;
      font-weight: 600;
      letter-spacing: -0.2px;
    }
    
    .waypoint-location {
      font-size: 12px;
      color: #6b7280;
      margin-top: 3px;
    }
    
    .waypoint-actions {
      display: flex;
      gap: 8px;
    }
    
    .waypoint-remove-btn {
      padding: 8px 14px;
      font-size: 12px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .waypoint-remove-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .empty-state {
      text-align: center;
      padding: 32px 24px;
      color: #9ca3af;
      font-size: 14px;
      background: linear-gradient(135deg, #fafbff 0%, #f9fafb 100%);
      border-radius: 12px;
      border: 2px dashed #e5e7eb;
    }
    
    .add-waypoint-btn {
      padding: 8px 14px;
      font-size: 12px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      margin-left: 8px;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      font-weight: 600;
    }
    
    .add-waypoint-btn:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .transport-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }
    
    .transport-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.25s;
    }
    
    .transport-btn:hover {
      border-color: #667eea;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .transport-btn:hover::before {
      opacity: 1;
    }
    
    .transport-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border-color: #667eea;
      box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }
    
    .transport-btn.active::before {
      opacity: 0;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>ğŸ—ºï¸ æ™ºèƒ½è·¯çº¿è§„åˆ’åŠ©æ‰‹</h1>
    <div class="subtitle">âœ¨ åŸºäºé«˜å¾·åœ°å›¾ MCP æœåŠ¡ + é€šä¹‰åƒé—® AI Agent Â· æ”¯æŒå¤šé€”ç»ç‚¹ä¼˜åŒ– âœ¨</div>

    <div class="card">
      <div class="row">
        <div class="field">
          <label>å‡ºå‘åœ°</label>
          <input id="start" placeholder="ä¾‹å¦‚ï¼šæ­å·è§å±±å›½é™…æœºåœº" />
        </div>
        <div class="field">
          <label>ç›®çš„åœ°</label>
          <input id="end" placeholder="ä¾‹å¦‚ï¼šæ­å·è¥¿æ¹–æ™¯åŒº" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex: 1 1 100%;">
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
            æç¤ºï¼šä¸ºé¿å…è·¨åŸå¸‚è¯¯åˆ¤ï¼Œè¯·åœ¨å‡ºå‘åœ°å’Œç›®çš„åœ°ä¸­å°½é‡åŒ…å«<strong>åŸå¸‚/åŒºå¿ä¿¡æ¯</strong>ï¼ˆä¾‹å¦‚â€œæ­å·è§å±±åŒºè¥¿å®‰ç”µå­ç§‘æŠ€å¤§å­¦æ­å·ç ”ç©¶é™¢â€ï¼‰ï¼Œå°¤å…¶æ˜¯åœ¨å¼‚åœ°è®¿é—®æˆ–ä½¿ç”¨ VPN æ—¶ã€‚
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>å‡ºè¡Œæ–¹å¼</label>
          <div style="display: flex; gap: 8px; margin-top: 4px;">
            <button type="button" class="transport-btn" data-mode="walking" style="flex: 1;">ğŸš¶ æ­¥è¡Œ</button>
            <button type="button" class="transport-btn active" data-mode="driving" style="flex: 1;">ğŸš— é©¾è½¦</button>
            <button type="button" class="transport-btn" data-mode="transit" style="flex: 1;">ğŸš‡ å…¬å…±äº¤é€š</button>
          </div>
        </div>
      </div>
      <button id="runBtn">â–¶ å¼€å§‹è§„åˆ’</button>
    </div>

    <!-- æ‹è§’ç‚¹å±•ç¤ºå¡ç‰‡å·²éšè—ï¼Œå¦‚éœ€è°ƒè¯•å¯å»æ‰ style æˆ–åˆ æ‰æ•´ä¸ª card -->
    <div class="card" style="display:none">
      <div class="section-title">æ‹è§’ç‚¹ï¼ˆäº¤å‰è·¯å£ï¼‰</div>
      <div class="section-sub">æ¥è‡ªæ­¥éª¤ 2 çš„æ‹è§’ç‚¹ JSON</div>
      <div id="waypoints" class="mono-box">// ç­‰å¾…è°ƒç”¨â€¦</div>
    </div>

    <!-- å…¬äº¤è·¯çº¿ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸï¼ˆä»…å…¬äº¤æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
    <div class="card" id="transitInfoCard" style="display:none;">
      <div class="section-title">ğŸšŒ å…¬äº¤è·¯çº¿ä¿¡æ¯</div>
      <div id="transitInfoContent"></div>
    </div>

    <!-- å¯¹è¯å¼å…´è¶£ç‚¹æœç´¢æ ç›® -->
    <div class="card" id="chatPoiSection" style="display:none;">
      <div class="section-title">ğŸ’¬ æ™ºèƒ½å…´è¶£ç‚¹åŠ©æ‰‹</div>
      <div class="section-sub">å‘Šè¯‰æˆ‘ä½ æƒ³åœ¨è·¯ä¸Šå»å“ªäº›åœ°æ–¹ï¼Œæˆ‘ä¼šå¸®ä½ æ‰¾åˆ°å¹¶å±•ç¤ºåœ¨åœ°å›¾ä¸Š</div>
      
      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div id="chatMessages" class="chat-messages"></div>
      
      <!-- å½“å‰æœç´¢ç»“æœ -->
      <div id="chatPoiButtons" style="margin-top:12px; display:none;">
        <div style="font-size:13px; color:#6b7380; margin-bottom:8px;">ğŸ“ æ‰¾åˆ°çš„åœ°ç‚¹ï¼š</div>
        <div id="chatPoiButtonsContainer"></div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="chat-input-area">
        <input 
          id="chatInput" 
          type="text" 
          placeholder="æ¯”å¦‚ï¼šæˆ‘æƒ³åƒç«é”…ã€æ‰¾ä¸ªåŠ æ²¹ç«™ã€ä¼‘æ¯å–å’–å•¡..." 
          class="chat-input"
        />
        <button id="chatSendBtn" class="chat-send-btn">å‘é€</button>
      </div>
    </div>

    <div class="card" id="poiDetailCard" style="display:none;">
      <div class="section-title">å…´è¶£ç‚¹è¯¦æƒ…ï¼ˆæ­¥éª¤4ï¼‰</div>
      <div class="section-sub">ç‚¹å‡»ä¸Šæ–¹æŸä¸ªå…´è¶£ç‚¹æŒ‰é’®åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¯¹åº”çš„è¯¦ç»†ä¿¡æ¯</div>
      <div id="poiDetail" class="poi-detail">å°šæœªè¯·æ±‚å…´è¶£ç‚¹è¯¦æƒ…</div>
    </div>

    <!-- é€”ç»ç‚¹åˆ—è¡¨å¡ç‰‡ -->
    <div class="card" id="waypointListCard" style="display:none;">
      <div class="section-title">æˆ‘çš„é€”ç»ç‚¹åˆ—è¡¨</div>
      <div class="section-sub">å·²æ·»åŠ çš„é€”ç»ç‚¹ï¼Œç‚¹å‡»"ä¼˜åŒ–è·¯çº¿"ç”Ÿæˆæœ€ä½³è·¯å¾„</div>
      <div id="waypointList" class="waypoint-list">
        <div class="empty-state">è¿˜æ²¡æœ‰æ·»åŠ é€”ç»ç‚¹</div>
      </div>
      
      <!-- ä¼˜åŒ–ç»“æœæ˜¾ç¤ºåŒº -->
      <div id="optimizedResult" style="display:none; margin-top: 16px; padding: 18px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 14px; border: 2px solid #86efac; box-shadow: 0 4px 14px rgba(134, 239, 172, 0.3); animation: fadeIn 0.5s ease-out;">
        <div style="font-size: 15px; font-weight: 700; color: #166534; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 20px;">âœ…</span>
          <span>è·¯çº¿ä¼˜åŒ–å®Œæˆ</span>
        </div>
        <div id="optimizedInfo" style="font-size: 13px; color: #15803d; line-height: 1.8; margin-bottom: 12px; padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 8px;">
        </div>
        <a id="openNavBtn" href="#" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.2s; margin-top: 4px;">
          <span style="font-size: 18px;">ğŸ—ºï¸</span>
          <span>æ‰“å¼€é«˜å¾·åœ°å›¾å¯¼èˆª</span>
        </a>
      </div>
      
      <div style="margin-top: 12px; display: flex; gap: 8px;">
        <button id="optimizeRouteBtn" onclick="optimizeRoute()" style="flex: 1;">
          ğŸ”„ ä¼˜åŒ–è·¯çº¿å¹¶å¯¼èˆª
        </button>
        <button id="clearWaypointsBtn" onclick="clearAllWaypoints()" style="background: #ef4444;">
          ğŸ—‘ï¸ æ¸…ç©º
        </button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">è°ƒç”¨è¿‡ç¨‹æ—¥å¿—</div>
      <div class="section-sub">æ¥è‡ªåç«¯ run_agent_with_retry æ‰“å°çš„è¿‡ç¨‹</div>
      <div id="logs" class="mono-box">// æ—¥å¿—è¾“å‡ºåŒº</div>
    </div>
  </div>

  <script>
    // API åŸºç¡€åœ°å€é…ç½®
    // åœ¨ç§»åŠ¨åº”ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼š
    // 1. ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
    // 2. ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚æœ API æœåŠ¡å™¨ä¸å‰ç«¯åœ¨åŒä¸€åŸŸåä¸‹ï¼‰
    // 3. åœ¨ Capacitor é…ç½®ä¸­è®¾ç½®æœåŠ¡å™¨åœ°å€
    function getApiBaseUrl() {
      // å‰ç«¯é€šè¿‡ Nginx éƒ¨ç½²åœ¨ 47.98.180.26:80ï¼Œåç«¯ API ä¹Ÿç”± Nginx ä»£ç†åˆ°åŒåŸŸçš„ /api
      // å› æ­¤å‰ç«¯ç»Ÿä¸€ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè®©æµè§ˆå™¨è¯·æ±‚å½“å‰åŸŸåä¸‹çš„ /api/*ï¼Œå†ç”± Nginx è½¬å‘åˆ° FastAPI
      return '';
    }
    
    const API_BASE_URL = getApiBaseUrl();
    
    const runBtn = document.getElementById('runBtn');
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const waypointsEl = document.getElementById('waypoints');
    const poiDetailEl = document.getElementById('poiDetail');
    const poiDetailCard = document.getElementById('poiDetailCard');
    const logsEl = document.getElementById('logs');
    
    // èŠå¤©ç•Œé¢å…ƒç´ 
    const chatPoiSection = document.getElementById('chatPoiSection');
    const chatMessages = document.getElementById('chatMessages');
    const chatPoiButtons = document.getElementById('chatPoiButtons');
    const chatPoiButtonsContainer = document.getElementById('chatPoiButtonsContainer');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    
    // å¯¹è¯å†å²
    let conversationHistory = [];
    
    // å‡ºè¡Œæ–¹å¼é€‰æ‹©
    let selectedTransportMode = 'driving';
    
    // ä¼šè¯IDï¼ˆç”¨äºé€”ç»ç‚¹ç®¡ç†ï¼‰
    let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // é€”ç»ç‚¹åˆ—è¡¨ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
    let waypointsList = [];
    
    // å½“å‰æŸ¥çœ‹çš„POIä¿¡æ¯ï¼ˆç”¨äºæ·»åŠ é€”ç»ç‚¹ï¼‰
    let currentPoiInfo = null;
    const transportBtns = document.querySelectorAll('.transport-btn');
    transportBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        transportBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedTransportMode = btn.getAttribute('data-mode');
      });
    });

    function appendLog(line) {
      const ts = new Date().toLocaleTimeString();
      logsEl.textContent += `[${ts}] ${line}\n`;
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    
    // ===== é€”ç»ç‚¹ç®¡ç†åŠŸèƒ½ =====
    
    // æ·»åŠ é€”ç»ç‚¹åˆ°è·¯çº¿
    async function addToWaypoints(poiName, poiId, location) {
      if (!poiName) {
        alert('POIåç§°ä¸ºç©ºï¼Œæ— æ³•æ·»åŠ ');
        return;
      }
      
      const start = startInput.value.trim();
      const end = endInput.value.trim();
      
      if (!start || !end) {
        alert('è¯·å…ˆè®¾ç½®èµ·ç‚¹å’Œç»ˆç‚¹');
        return;
      }
      
      appendLog(`[é€”ç»ç‚¹] æ­£åœ¨æ·»åŠ ï¼š${poiName}`);
      
      try {
        const resp = await fetch(`${API_BASE_URL}/api/add_waypoint`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            waypoint_name: poiName,
            poi_id: poiId || null,
            start: start,
            end: end,
            // æŠŠå½“å‰å‡ºè¡Œæ–¹å¼ä¸€å¹¶ä¼ ç»™åç«¯ï¼Œç”¨äºå…¬äº¤æ¨¡å¼ä¸‹é™åˆ¶å¤šé€”ç»ç‚¹
            transport_mode: selectedTransportMode
          })
        });
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        
        const data = await resp.json();
        
        if (data.success) {
          appendLog(`[é€”ç»ç‚¹] æ·»åŠ æˆåŠŸï¼š${poiName}`);
          waypointsList = data.waypoints || [];
          renderWaypointsList();
          
          // æ˜¾ç¤ºé€”ç»ç‚¹åˆ—è¡¨å¡ç‰‡
          const waypointListCard = document.getElementById('waypointListCard');
          if (waypointListCard) {
            waypointListCard.style.display = 'block';
          }
          
          // æç¤ºç”¨æˆ·
          alert(`âœ… å·²æ·»åŠ é€”ç»ç‚¹ï¼š${poiName}\n\nå½“å‰å…± ${waypointsList.length} ä¸ªé€”ç»ç‚¹`);
        } else {
          appendLog(`[é€”ç»ç‚¹] æ·»åŠ å¤±è´¥ï¼š${data.message}`);
          alert(`æ·»åŠ å¤±è´¥ï¼š${data.message}`);
        }
        
        // æ˜¾ç¤ºæ—¥å¿—
        if (data.logs) {
          const logLines = data.logs.split('\n');
          logLines.forEach(line => {
            if (line.trim() && line.includes('[æ·»åŠ é€”ç»ç‚¹]')) {
              appendLog(line);
            }
          });
        }
      } catch (err) {
        console.error(err);
        appendLog(`[é€”ç»ç‚¹] æ·»åŠ å¼‚å¸¸ï¼š${err}`);
        alert(`æ·»åŠ é€”ç»ç‚¹å¤±è´¥ï¼š${err.message}`);
      }
    }
    
    // æ¸²æŸ“é€”ç»ç‚¹åˆ—è¡¨
    function renderWaypointsList() {
      const waypointListEl = document.getElementById('waypointList');
      
      if (!waypointsList || waypointsList.length === 0) {
        waypointListEl.innerHTML = '<div class="empty-state">è¿˜æ²¡æœ‰æ·»åŠ é€”ç»ç‚¹</div>';
        return;
      }
      
      let html = '';
      waypointsList.forEach((wp, index) => {
        const locationText = wp.location ? `ğŸ“ ${wp.location}` : 'åæ ‡å¾…è§£æ';
        html += `
          <div class="waypoint-item">
            <div class="waypoint-info">
              <div class="waypoint-order">${index + 1}</div>
              <div>
                <div class="waypoint-name">${escapeHtml(wp.name)}</div>
                <div class="waypoint-location">${locationText}</div>
              </div>
            </div>
            <div class="waypoint-actions">
              <button class="waypoint-remove-btn" onclick="removeWaypoint(${index})">
                ğŸ—‘ï¸ åˆ é™¤
              </button>
            </div>
          </div>
        `;
      });
      
      waypointListEl.innerHTML = html;
    }
    
    // åˆ é™¤é€”ç»ç‚¹
    async function removeWaypoint(index) {
      if (index < 0 || index >= waypointsList.length) {
        return;
      }
      
      const wp = waypointsList[index];
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€”ç»ç‚¹ã€Œ${wp.name}ã€å—ï¼Ÿ`)) {
        return;
      }
      
      appendLog(`[é€”ç»ç‚¹] æ­£åœ¨åˆ é™¤ï¼š${wp.name}`);
      
      try {
        const resp = await fetch(`${API_BASE_URL}/api/remove_waypoint`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            waypoint_index: index
          })
        });
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        
        const data = await resp.json();
        
        if (data.success) {
          appendLog(`[é€”ç»ç‚¹] åˆ é™¤æˆåŠŸï¼š${wp.name}`);
          waypointsList = data.waypoints || [];
          renderWaypointsList();
          
          // å¦‚æœæ²¡æœ‰é€”ç»ç‚¹äº†ï¼Œéšè—å¡ç‰‡
          if (waypointsList.length === 0) {
            const waypointListCard = document.getElementById('waypointListCard');
            if (waypointListCard) {
              waypointListCard.style.display = 'none';
            }
          }
        } else {
          appendLog(`[é€”ç»ç‚¹] åˆ é™¤å¤±è´¥ï¼š${data.message}`);
          alert(`åˆ é™¤å¤±è´¥ï¼š${data.message}`);
        }
      } catch (err) {
        console.error(err);
        appendLog(`[é€”ç»ç‚¹] åˆ é™¤å¼‚å¸¸ï¼š${err}`);
        alert(`åˆ é™¤é€”ç»ç‚¹å¤±è´¥ï¼š${err.message}`);
      }
    }
    
    // æ¸…ç©ºæ‰€æœ‰é€”ç»ç‚¹
    function clearAllWaypoints() {
      if (waypointsList.length === 0) {
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${waypointsList.length} ä¸ªé€”ç»ç‚¹å—ï¼Ÿ`)) {
        return;
      }
      
      // é€ä¸ªåˆ é™¤
      const deletePromises = [];
      for (let i = waypointsList.length - 1; i >= 0; i--) {
        deletePromises.push(
          fetch(`${API_BASE_URL}/api/remove_waypoint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: sessionId,
              waypoint_index: i
            })
          })
        );
      }
      
      Promise.all(deletePromises).then(() => {
        waypointsList = [];
        renderWaypointsList();
        
        const waypointListCard = document.getElementById('waypointListCard');
        if (waypointListCard) {
          waypointListCard.style.display = 'none';
        }
        
        appendLog('[é€”ç»ç‚¹] å·²æ¸…ç©ºæ‰€æœ‰é€”ç»ç‚¹');
      }).catch(err => {
        console.error(err);
        alert(`æ¸…ç©ºå¤±è´¥ï¼š${err.message}`);
      });
    }
    
    // ä¼˜åŒ–è·¯çº¿å¹¶å¯¼èˆª
    async function optimizeRoute() {
      const start = startInput.value.trim();
      const end = endInput.value.trim();
      
      if (!start || !end) {
        alert('è¯·å…ˆè®¾ç½®èµ·ç‚¹å’Œç»ˆç‚¹');
        return;
      }
      
      if (waypointsList.length === 0) {
        alert('è¯·å…ˆæ·»åŠ é€”ç»ç‚¹');
        return;
      }
      
      appendLog(`[è·¯çº¿ä¼˜åŒ–] å¼€å§‹ä¼˜åŒ–è·¯çº¿ï¼ŒåŒ…å« ${waypointsList.length} ä¸ªé€”ç»ç‚¹...`);
      
      const optimizeBtn = document.getElementById('optimizeRouteBtn');
      optimizeBtn.disabled = true;
      optimizeBtn.textContent = 'â³ ä¼˜åŒ–ä¸­...';
      
      try {
        const resp = await fetch(`${API_BASE_URL}/api/optimize_route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            start: start,
            end: end,
            transport_mode: selectedTransportMode
          })
        });
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        
        const data = await resp.json();
        
        if (data.success) {
          appendLog(`[è·¯çº¿ä¼˜åŒ–] ä¼˜åŒ–æˆåŠŸï¼`);
          appendLog(`[è·¯çº¿ä¼˜åŒ–] æ€»è·ç¦»ï¼š${data.total_distance_km ? data.total_distance_km.toFixed(1) + ' å…¬é‡Œ' : 'æœªçŸ¥'}`);
          appendLog(`[è·¯çº¿ä¼˜åŒ–] é¢„è®¡æ—¶é—´ï¼š${data.total_duration_min ? Math.round(data.total_duration_min) + ' åˆ†é’Ÿ' : 'æœªçŸ¥'}`);
          
          // æ›´æ–°é€”ç»ç‚¹åˆ—è¡¨ï¼ˆå·²ä¼˜åŒ–é¡ºåºï¼‰
          waypointsList = data.optimized_waypoints || [];
          renderWaypointsList();
          
          // æ˜¾ç¤ºè·¯çº¿æ‘˜è¦
          if (data.route_summary) {
            appendLog(`[è·¯çº¿æ‘˜è¦] ${data.route_summary}`);
          }
          
          // æ˜¾ç¤ºæ—¥å¿—
          if (data.logs) {
            appendLog('--- è·¯çº¿ä¼˜åŒ–è¯¦ç»†æ—¥å¿— ---');
            const logLines = data.logs.split('\n');
            logLines.forEach(line => {
              if (line.trim() && line.includes('[è·¯çº¿ä¼˜åŒ–]')) {
                appendLog(line);
              }
            });
            appendLog('--- è·¯çº¿ä¼˜åŒ–æ—¥å¿—ç»“æŸ ---');
          }
          
          // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
          const waypointNames = data.optimized_waypoints.map(wp => wp.name).join(' â†’ ');
          const distanceText = data.total_distance_km ? `${data.total_distance_km.toFixed(1)} å…¬é‡Œ` : 'æœªçŸ¥';
          const durationText = data.total_duration_min ? `${Math.round(data.total_duration_min)} åˆ†é’Ÿ` : 'æœªçŸ¥';
          
          const optimizedResult = document.getElementById('optimizedResult');
          const optimizedInfo = document.getElementById('optimizedInfo');
          const openNavBtn = document.getElementById('openNavBtn');
          
          if (optimizedInfo) {
            optimizedInfo.innerHTML = `
              ğŸ“ <strong>è·¯çº¿ï¼š</strong>${escapeHtml(start)} â†’ ${escapeHtml(waypointNames)} â†’ ${escapeHtml(end)}<br>
              ğŸ“ <strong>æ€»è·ç¦»ï¼š</strong>${distanceText}<br>
              â±ï¸ <strong>é¢„è®¡æ—¶é—´ï¼š</strong>${durationText}
            `;
          }
          
          // æ‰“å¼€é«˜å¾·åœ°å›¾å¯¼èˆª
          if (data.nav_url) {
            appendLog(`[å¯¼èˆª] æ­£åœ¨æ‰“å¼€é«˜å¾·åœ°å›¾...`);
            appendLog(`[å¯¼èˆª] å¯¼èˆªé“¾æ¥ï¼š${data.nav_url}`);
            
            // è®¾ç½®å¯¼èˆªæŒ‰é’®é“¾æ¥
            if (openNavBtn) {
              openNavBtn.href = data.nav_url;
              openNavBtn.style.display = 'inline-flex';
            }
            
            // æ˜¾ç¤ºä¼˜åŒ–ç»“æœåŒºåŸŸ
            if (optimizedResult) {
              optimizedResult.style.display = 'block';
            }
            
            // å…ˆå°è¯•è‡ªåŠ¨æ‰“å¼€å¯¼èˆªé“¾æ¥
            const opened = window.open(data.nav_url, '_blank');
            
            if (opened) {
              // æˆåŠŸæ‰“å¼€
              appendLog(`[å¯¼èˆª] âœ… å·²åœ¨æ–°çª—å£æ‰“å¼€é«˜å¾·åœ°å›¾`);
              alert(`âœ… è·¯çº¿ä¼˜åŒ–å®Œæˆï¼\n\nå·²åœ¨æ–°çª—å£æ‰“å¼€é«˜å¾·åœ°å›¾å¯¼èˆª\nå¦‚æœªè‡ªåŠ¨æ‰“å¼€ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹ç»¿è‰²æŒ‰é’®`);
            } else {
              // è¢«æµè§ˆå™¨é˜»æ­¢
              appendLog(`[å¯¼èˆª] âš ï¸ æµè§ˆå™¨é˜»æ­¢äº†å¼¹å‡ºçª—å£`);
              alert(`âœ… è·¯çº¿ä¼˜åŒ–å®Œæˆï¼\n\nâš ï¸ æµè§ˆå™¨é˜»æ­¢äº†å¼¹å‡ºçª—å£\nè¯·ç‚¹å‡»ä¸‹æ–¹ç»¿è‰²"æ‰“å¼€é«˜å¾·åœ°å›¾å¯¼èˆª"æŒ‰é’®`);
            }
          } else {
            // æ²¡æœ‰å¯¼èˆªé“¾æ¥
            if (openNavBtn) {
              openNavBtn.style.display = 'none';
            }
            if (optimizedResult) {
              optimizedResult.style.display = 'block';
            }
            alert(`âœ… è·¯çº¿ä¼˜åŒ–å®Œæˆï¼\n\nä½†æœªèƒ½ç”Ÿæˆå¯¼èˆªé“¾æ¥ï¼Œè¯·æ‰‹åŠ¨åœ¨é«˜å¾·åœ°å›¾ä¸­è¾“å…¥é€”ç»ç‚¹ã€‚`);
          }
        } else {
          appendLog(`[è·¯çº¿ä¼˜åŒ–] ä¼˜åŒ–å¤±è´¥ï¼š${data.message}`);
          alert(`è·¯çº¿ä¼˜åŒ–å¤±è´¥ï¼š${data.message}`);
          
          // æ˜¾ç¤ºæ—¥å¿—
          if (data.logs) {
            const logLines = data.logs.split('\n');
            logLines.forEach(line => {
              if (line.trim()) {
                appendLog(line);
              }
            });
          }
        }
      } catch (err) {
        console.error(err);
        appendLog(`[è·¯çº¿ä¼˜åŒ–] ä¼˜åŒ–å¼‚å¸¸ï¼š${err}`);
        alert(`è·¯çº¿ä¼˜åŒ–å¤±è´¥ï¼š${err.message}`);
      } finally {
        optimizeBtn.disabled = false;
        optimizeBtn.textContent = 'ğŸ”„ ä¼˜åŒ–è·¯çº¿å¹¶å¯¼èˆª';
      }
    }

    function renderPoiDetail(rawDetail, extraDistanceKm, viaNavUrl, alightStopName, walkNavUrl, showAddToRoute) {
      // å°è¯•å°† detail è§£æä¸º JSON å¯¹è±¡
      let obj = null;
      if (rawDetail && typeof rawDetail === 'object') {
        obj = rawDetail;
      } else if (typeof rawDetail === 'string') {
        try {
          obj = JSON.parse(rawDetail);
        } catch (e) {
          obj = null;
        }
      }

      // å¦‚æœä¸æ˜¯ç»“æ„åŒ– JSONï¼Œå°±é€€å›åˆ°åŸæ¥çš„çº¯æ–‡æœ¬å±•ç¤º
      if (!obj) {
        poiDetailEl.className = 'mono-box';
        poiDetailEl.textContent = rawDetail || '// åç«¯æœªè¿”å›å…´è¶£ç‚¹è¯¦æƒ…å†…å®¹';
        return;
      }

      const {
        name,
        city,
        address,
        business_area,
        type,
        rating,
        cost,
        open_time,
        opentime2,
        meal_ordering,
        photo,
        location,
      } = obj;

      const prettyCost = cost ? `çº¦ ${escapeHtml(String(cost))} å…ƒ` : 'æš‚æ— æ•°æ®';
      const mealOrderingText =
        meal_ordering === '1' || meal_ordering === 1
          ? 'æ”¯æŒåœ¨çº¿ç‚¹é¤'
          : 'æš‚ä¸æ”¯æŒåœ¨çº¿ç‚¹é¤';
      const openText = opentime2 || open_time || 'æ— è¥ä¸šæ—¶é—´ä¿¡æ¯';

      // è®¡ç®—é«˜å¾·åœ°å›¾è·³è½¬é“¾æ¥
      // ä½¿ç”¨é«˜å¾·åœ°å›¾ ditu.amap.com çš„æ ‡å‡†æ ¼å¼
      // èµ·ç‚¹ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å‡ºå‘ç‚¹ï¼Œå¦‚æœæœªè®¾ç½®åˆ™ä½¿ç”¨"æˆ‘çš„ä½ç½®"
      
      // æ ¹æ®é€‰æ‹©çš„å‡ºè¡Œæ–¹å¼è®¾ç½®é«˜å¾·åœ°å›¾çš„ type å‚æ•°
      let amapType = 'car'; // é»˜è®¤é©¾è½¦
      if (selectedTransportMode === 'walking') {
        amapType = 'walk';
      } else if (selectedTransportMode === 'transit') {
        amapType = 'bus';
      } else {
        amapType = 'car';
      }
      
      // è·å–ç”¨æˆ·è®¾ç½®çš„èµ·ç‚¹
      const userStart = startInput.value.trim();
      let fromName, fromId;
      if (userStart) {
        // å¦‚æœç”¨æˆ·è¾“å…¥äº†èµ·ç‚¹ï¼Œä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„èµ·ç‚¹åç§°
        fromName = encodeURIComponent(userStart);
        fromId = ''; // ä¸ä½¿ç”¨ dirmylocï¼Œè®©é«˜å¾·åœ°å›¾è§£æåœ°å€åç§°
      } else {
        // å¦‚æœç”¨æˆ·æœªè¾“å…¥èµ·ç‚¹ï¼Œä½¿ç”¨"æˆ‘çš„ä½ç½®"
        fromName = encodeURIComponent('æˆ‘çš„ä½ç½®');
        fromId = 'dirmyloc';
      }
      
      // å…¬äº¤æ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨ walkNavUrlï¼ˆä»å…¬äº¤ç«™åˆ°POIçš„æ­¥è¡Œå¯¼èˆªï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ viaNavUrl æˆ–ç”Ÿæˆé»˜è®¤å¯¼èˆªé“¾æ¥
      // é©¾è½¦/æ­¥è¡Œæ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„"èµ·ç‚¹-é€”ç»ç‚¹-ç»ˆç‚¹"å¯¼èˆªé“¾æ¥
      let amapUrl = '';
      if (selectedTransportMode === 'transit' && walkNavUrl) {
        // å…¬äº¤æ¨¡å¼ï¼šä½¿ç”¨ä»å…¬äº¤ç«™åˆ°POIçš„æ­¥è¡Œå¯¼èˆª
        amapUrl = walkNavUrl;
      } else if (viaNavUrl) {
        // é©¾è½¦/æ­¥è¡Œæ¨¡å¼ï¼šä½¿ç”¨åç«¯è¿”å›çš„å¯¼èˆªé“¾æ¥
        amapUrl = viaNavUrl;
      } else {
        // å›é€€ï¼šç”Ÿæˆé»˜è®¤å¯¼èˆªé“¾æ¥
        if (location && typeof location === 'string' && location.includes(',')) {
          // æœ‰POIåæ ‡ï¼Œä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼ˆä»…èµ·ç‚¹->POIï¼Œä½œä¸ºå›é€€ï¼‰
          const toLnglat = location; // å·²ç»æ˜¯ 'lon,lat' æ ¼å¼
          const toName = encodeURIComponent(name || 'ç›®çš„åœ°');
          if (fromId) {
            // ä½¿ç”¨"æˆ‘çš„ä½ç½®"æ—¶ï¼Œéœ€è¦ from[id]
            amapUrl = `https://ditu.amap.com/dir?type=${amapType}&policy=2&from[name]=${fromName}&from[id]=${fromId}&to[lnglat]=${toLnglat}&to[name]=${toName}&src=uriapi&callnative=0&innersrc=uriapi`;
          } else {
            // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„èµ·ç‚¹æ—¶ï¼Œä¸ä¼  from[id]
            amapUrl = `https://ditu.amap.com/dir?type=${amapType}&policy=2&from[name]=${fromName}&to[lnglat]=${toLnglat}&to[name]=${toName}&src=uriapi&callnative=0&innersrc=uriapi`;
          }
        } else {
          // æ²¡æœ‰ç»çº¬åº¦æ—¶ï¼Œåªä½¿ç”¨åœ°å€åç§°
          const toName = encodeURIComponent(name || 'ç›®çš„åœ°');
          if (fromId) {
            // ä½¿ç”¨"æˆ‘çš„ä½ç½®"æ—¶ï¼Œéœ€è¦ from[id]
            amapUrl = `https://ditu.amap.com/dir?type=${amapType}&policy=2&from[name]=${fromName}&from[id]=${fromId}&to[name]=${toName}&src=uriapi&callnative=0&innersrc=uriapi`;
          } else {
            // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„èµ·ç‚¹æ—¶ï¼Œä¸ä¼  from[id]
            amapUrl = `https://ditu.amap.com/dir?type=${amapType}&policy=2&from[name]=${fromName}&to[name]=${toName}&src=uriapi&callnative=0&innersrc=uriapi`;
          }
        }
      }

      poiDetailEl.className = 'poi-detail';
      poiDetailEl.innerHTML = `
        <div class="poi-card">
          <div class="poi-card-main">
            <div style="margin-bottom:4px;">
              <h3>
                ${escapeHtml(name || 'æœªå‘½åå…´è¶£ç‚¹')}
                ${
                  type
                    ? `<span class="poi-badge">${
                        escapeHtml(type.split(';')[2] || type.split(';')[1] || type)
                      }</span>`
                    : ''
                }
              </h3>
            </div>
            <div class="poi-meta">
              ${rating ? `<span>è¯„åˆ†ï¼š${escapeHtml(String(rating))} åˆ†</span>` : ''}
              ${cost ? `<span>äººå‡æ¶ˆè´¹ï¼š${prettyCost}</span>` : ''}
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">åŸå¸‚ï¼š</span>
              <span>${escapeHtml(city || 'æœªçŸ¥åŸå¸‚')}</span>
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">å•†åœˆï¼š</span>
              <span>${escapeHtml(business_area || 'æ— å•†åœˆä¿¡æ¯')}</span>
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">åœ°å€ï¼š</span>
              <span>${escapeHtml(address || 'æ— è¯¦ç»†åœ°å€')}</span>
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">è¥ä¸šæ—¶é—´ï¼š</span>
              <span>${escapeHtml(openText)}</span>
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">åœ¨çº¿ç‚¹é¤ï¼š</span>
              <span>${mealOrderingText}</span>
            </div>
            <div class="poi-info-line">
              <span class="poi-info-label">ç»•è·¯è·ç¦»ï¼š</span>
              <span>${
                typeof extraDistanceKm === 'number'
                  ? `å¤§çº¦å¤šè¡Œé©¶ ${extraDistanceKm.toFixed(1)} å…¬é‡Œ`
                  : 'æš‚æ— æ³•è®¡ç®—'
              }</span>
            </div>
            ${
              selectedTransportMode === 'transit'
                ? `<div style="margin-top: 12px; padding: 12px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #1890ff;">
                     <div style="font-weight: bold; color: #1890ff; margin-bottom: 8px;">
                       ğŸšŒ å…¬äº¤å‡ºè¡Œæç¤º
                     </div>
                     ${
                       alightStopName
                         ? `<div style="color: #666; margin-bottom: 8px;">
                              è¯·åœ¨ <strong style="color: #1890ff;">${escapeHtml(alightStopName)}</strong> ä¸‹è½¦
                            </div>`
                         : '<div style="color: #666; margin-bottom: 8px;">å»ºè®®åœ¨æœ€è¿‘çš„å…¬äº¤ç«™ä¸‹è½¦åæ­¥è¡Œå‰å¾€</div>'
                     }
                   </div>`
                : ''
            }
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              ${
                amapUrl
                  ? `<a
                       class="poi-route-btn"
                       href="${escapeHtml(amapUrl)}"
                       target="_blank"
                       rel="noopener"
                       style="flex: 1;"
                     >
                       ${selectedTransportMode === 'transit' && walkNavUrl ? 'ğŸš¶ æ­¥è¡Œå‰å¾€' : 'ğŸš— å»è¿™é‡Œ'}
                     </a>`
                  : ''
              }
              ${
                (showAddToRoute === undefined || showAddToRoute !== false) && selectedTransportMode !== 'transit'
                  ? `<button 
                       class="add-waypoint-btn" 
                       onclick="addToWaypoints('${escapeHtml(name || '')}', '${escapeHtml(obj.id || '')}', '${escapeHtml(location || '')}')"
                       style="flex: 1;"
                     >
                       â• åŠ å…¥è·¯çº¿
                     </button>`
                  : ''
              }
            </div>
          </div>
          ${
            photo
              ? `<div class="poi-photo">
                   <img src="${escapeHtml(photo)}" alt="${escapeHtml(name || 'å…´è¶£ç‚¹å›¾ç‰‡')}">
                 </div>`
              : ''
          }
        </div>
      `;
    }

    // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
    function addChatMessage(role, content, extractedKeywords) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      
      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'chat-avatar';
      avatarDiv.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'chat-bubble';
      bubbleDiv.textContent = content;
      
      // å¦‚æœæå–äº†å…³é”®è¯ï¼Œæ˜¾ç¤ºæ ‡ç­¾
      if (extractedKeywords) {
        const keywordBadge = document.createElement('div');
        keywordBadge.className = 'chat-keyword-badge';
        keywordBadge.textContent = `ğŸ” æœç´¢å…³é”®è¯ï¼š${extractedKeywords}`;
        bubbleDiv.appendChild(keywordBadge);
      }
      
      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(bubbleDiv);
      chatMessages.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ¸²æŸ“èŠå¤©ç•Œé¢çš„å…´è¶£ç‚¹æŒ‰é’®
    function renderChatPoiButtons(pois, pois_ids) {
      chatPoiButtonsContainer.innerHTML = '';
      
      if (!pois_ids || pois_ids.length === 0) {
        chatPoiButtons.style.display = 'none';
        return;
      }
      
      chatPoiButtons.style.display = 'block';
      
      let poiNames = [];
      if (Array.isArray(pois)) {
        poiNames = pois.map(p => (p && p.name) ? p.name : '');
      }

      pois_ids.forEach((id, idx) => {
        const btn = document.createElement('button');
        const nameFromPois = poiNames[idx] || '';
        btn.textContent = nameFromPois ? nameFromPois : `å…´è¶£ç‚¹ ${idx + 1}`;
        btn.title = `POI id: ${id}`;
        btn.style.marginRight = '6px';
        btn.style.marginBottom = '6px';
        btn.onclick = async () => {
          const start = startInput.value.trim();
          const end = endInput.value.trim();
          appendLog(`ç‚¹å‡»å…´è¶£ç‚¹ ${idx + 1}ï¼Œè¯·æ±‚è¯¦æƒ…ï¼Œid=${id}`);
          try {
            const detailController = new AbortController();
            const detailTimeoutId = setTimeout(() => detailController.abort(), 30000);
            
            let detailResp;
            try {
              detailResp = await fetch(`${API_BASE_URL}/api/poi_detail`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  poi_id: id,
                  start,
                  end,
                  transport_mode: selectedTransportMode,
                }),
                signal: detailController.signal,
              });
            } catch (detailFetchError) {
              clearTimeout(detailTimeoutId);
              if (detailFetchError.name === 'AbortError') {
                appendLog('å…´è¶£ç‚¹è¯¦æƒ…è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰');
                if (poiDetailCard) {
                  poiDetailCard.style.display = 'block';
                }
                poiDetailEl.textContent = 'è¯·æ±‚è¶…æ—¶ï¼šè¯·ç¨åé‡è¯•';
                return;
              }
              throw detailFetchError;
            }
            clearTimeout(detailTimeoutId);
            if (!detailResp.ok) {
              appendLog(`å…´è¶£ç‚¹è¯¦æƒ…è¯·æ±‚å¤±è´¥ï¼šHTTP ${detailResp.status}`);
              if (poiDetailCard) {
                poiDetailCard.style.display = 'block';
              }
              poiDetailEl.textContent = `è·å–å…´è¶£ç‚¹è¯¦æƒ…å¤±è´¥ï¼šHTTP ${detailResp.status}`;
              return;
            }
            const detailData = await detailResp.json();
            const preview = typeof detailData.detail === 'string'
              ? detailData.detail.slice(0, 200)
              : JSON.stringify(detailData.detail).slice(0, 200);
            appendLog(`å…´è¶£ç‚¹è¯¦æƒ…ï¼š${preview}...`);
            
            if (detailData.logs) {
              appendLog('--- æ­¥éª¤å››è¯¦ç»†æ—¥å¿— ---');
              const logLines = detailData.logs.split('\n');
              logLines.forEach(line => {
                if (line.trim()) {
                  appendLog(line);
                }
              });
              appendLog('--- æ­¥éª¤å››æ—¥å¿—ç»“æŸ ---');
            }
            
            console.log('æ­¥éª¤å››å“åº”æ•°æ®ï¼š', detailData);
            // æ˜¾ç¤ºå…´è¶£ç‚¹è¯¦æƒ…å¡ç‰‡
            if (poiDetailCard) {
              poiDetailCard.style.display = 'block';
            }
            renderPoiDetail(
              detailData.detail, 
              detailData.extra_distance_km, 
              detailData.via_nav_url,
              detailData.alight_stop_name,
              detailData.walk_nav_url,
              detailData.show_add_to_route
            );
          } catch (e) {
            console.error(e);
            appendLog(`å…´è¶£ç‚¹è¯¦æƒ…è¯·æ±‚å¼‚å¸¸ï¼š${e}`);
            if (poiDetailCard) {
              poiDetailCard.style.display = 'block';
            }
            poiDetailEl.textContent = `å…´è¶£ç‚¹è¯¦æƒ…è¯·æ±‚å¼‚å¸¸ï¼š${e}`;
          }
        };
        chatPoiButtonsContainer.appendChild(btn);
      });
    }
    
    // å‘é€èŠå¤©æ¶ˆæ¯
    async function sendChatMessage() {
      const start = startInput.value.trim();
      const end = endInput.value.trim();
      const message = chatInput.value.trim();

      if (!start || !end) {
        alert('è¯·å…ˆè¿›è¡Œè·¯çº¿è§„åˆ’');
        return;
      }

      if (!message) {
        return;
      }

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addChatMessage('user', message);
      chatInput.value = '';
      chatSendBtn.disabled = true;
      chatInput.disabled = true;

      appendLog(`[å¯¹è¯] ç”¨æˆ·ï¼š${message}`);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);
        
        let resp;
        try {
          resp = await fetch(`${API_BASE_URL}/api/chat_poi`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              start, 
              end, 
              message,
              transport_mode: selectedTransportMode,
              conversation_history: conversationHistory,
              session_id: sessionId
            }),
            signal: controller.signal,
          });
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            appendLog('[å¯¹è¯] è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰');
            addChatMessage('assistant', 'æŠ±æ­‰ï¼Œè¯·æ±‚è¶…æ—¶äº†ï¼Œè¯·é‡è¯•ã€‚');
            return;
          }
          throw fetchError;
        }
        clearTimeout(timeoutId);

        if (!resp.ok) {
          const errorText = await resp.text();
          appendLog(`[å¯¹è¯] è¯·æ±‚å¤±è´¥ï¼š${resp.status} - ${errorText}`);
          addChatMessage('assistant', `æŠ±æ­‰ï¼Œé‡åˆ°äº†é—®é¢˜ï¼š${errorText}`);
          return;
        }

        const data = await resp.json();
        
        // æ·»åŠ åŠ©æ‰‹å›å¤åˆ°ç•Œé¢
        addChatMessage('assistant', data.reply, data.extracted_keywords);
        appendLog(`[å¯¹è¯] åŠ©æ‰‹ï¼š${data.reply}`);
        
        // æ›´æ–°å¯¹è¯å†å²
        conversationHistory = data.conversation_history || [];
        
        // å¤„ç†ä¸åŒçš„åŠ¨ä½œç±»å‹
        if (data.action === 'add_waypoint' && data.waypoint_added) {
          // æ·»åŠ é€”ç»ç‚¹æˆåŠŸ
          appendLog(`[å¯¹è¯] å·²æ·»åŠ é€”ç»ç‚¹ï¼š${data.waypoint_added}`);
          
          // åˆ·æ–°é€”ç»ç‚¹åˆ—è¡¨
          try {
            const listResp = await fetch(`${API_BASE_URL}/api/list_waypoints`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ session_id: sessionId })
            });
            
            if (listResp.ok) {
              const listData = await listResp.json();
              waypointsList = listData.waypoints || [];
              renderWaypointsList();
              
              // æ˜¾ç¤ºé€”ç»ç‚¹åˆ—è¡¨å¡ç‰‡
              const waypointListCard = document.getElementById('waypointListCard');
              if (waypointListCard && waypointsList.length > 0) {
                waypointListCard.style.display = 'block';
              }
            }
          } catch (err) {
            console.error('åˆ·æ–°é€”ç»ç‚¹åˆ—è¡¨å¤±è´¥ï¼š', err);
          }
          
          chatPoiButtons.style.display = 'none';
        } else if (data.action === 'search' && Array.isArray(data.pois) && data.pois.length > 0) {
          // æœç´¢å…´è¶£ç‚¹æˆåŠŸ
          appendLog(`[å¯¹è¯] æ‰¾åˆ° ${data.pois.length} ä¸ªå…´è¶£ç‚¹`);
          renderChatPoiButtons(data.pois, data.pois_ids);
        } else {
          chatPoiButtons.style.display = 'none';
        }

        // æ˜¾ç¤ºæ—¥å¿—
        if (data.logs) {
          const logLines = data.logs.split('\n');
          logLines.forEach(line => {
            if (line.trim() && line.includes('[å¯¹è¯POI]')) {
              appendLog(line);
            }
          });
        }

      } catch (err) {
        console.error(err);
        appendLog(`[å¯¹è¯] å¼‚å¸¸ï¼š${err}`);
        addChatMessage('assistant', 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
      } finally {
        chatSendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
      }
    }
    
    // èŠå¤©å‘é€æŒ‰é’®äº‹ä»¶
    chatSendBtn.onclick = sendChatMessage;
    
    // å›è½¦å‘é€
    chatInput.onkeypress = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    };

    runBtn.onclick = async () => {
      const start = startInput.value.trim();
      const end = endInput.value.trim();

      if (!start || !end) {
        alert('è¯·å¡«å†™å‡ºå‘åœ°å’Œç›®çš„åœ°');
        return;
      }

      runBtn.disabled = true;
      runBtn.textContent = 'è§„åˆ’ä¸­â€¦';

      waypointsEl.textContent = '// ç­‰å¾…è¿”å›æ‹è§’ç‚¹â€¦';
      logsEl.textContent = '';
      poiDetailEl.className = 'poi-detail';
      poiDetailEl.textContent = 'å°šæœªè¯·æ±‚å…´è¶£ç‚¹è¯¦æƒ…';
      
      // æ¸…ç©ºé€”ç»ç‚¹åˆ—è¡¨ï¼Œé˜²æ­¢ä¹‹å‰å†…å®¹å½±å“åç»­å†…å®¹
      waypointsList = [];
      renderWaypointsList();
      const waypointListCard = document.getElementById('waypointListCard');
      if (waypointListCard) {
        waypointListCard.style.display = 'none';
      }
      const optimizedResult = document.getElementById('optimizedResult');
      if (optimizedResult) {
        optimizedResult.style.display = 'none';
      }
      
      // éšè—å…´è¶£ç‚¹è¯¦æƒ…å¡ç‰‡ã€èŠå¤©ç•Œé¢å’Œå…¬äº¤è·¯çº¿ä¿¡æ¯
      if (poiDetailCard) {
        poiDetailCard.style.display = 'none';
      }
      chatPoiSection.style.display = 'none';
      const transitInfoCard = document.getElementById('transitInfoCard');
      if (transitInfoCard) {
        transitInfoCard.style.display = 'none';
      }

      appendLog(`è¯·æ±‚å¼€å§‹ï¼š${start} -> ${end}, å‡ºè¡Œæ–¹å¼ï¼š${selectedTransportMode}`);

      try {
        // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ120ç§’ï¼Œä¸åç«¯æ€»è¶…æ—¶æ—¶é—´ä¸€è‡´ï¼‰
        // è·¯çº¿è§„åˆ’ä»»åŠ¡å¯èƒ½éœ€è¦å¤šæ¬¡MCPè°ƒç”¨ï¼Œå¤„ç†æ—¶é—´å¯èƒ½è¾ƒé•¿
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);  // 120ç§’ = 2åˆ†é’Ÿ
        
        appendLog('å¼€å§‹è¯·æ±‚è·¯çº¿è§„åˆ’ï¼Œé¢„è®¡éœ€è¦30-90ç§’...');
        let resp;
        try {
          resp = await fetch(`${API_BASE_URL}/api/route`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start, end, transport_mode: selectedTransportMode }),
            signal: controller.signal,
          });
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            appendLog('è¯·æ±‚è¶…æ—¶ï¼ˆ120ç§’ï¼‰ï¼Œåç«¯å¯èƒ½å·²å¡æ­»æˆ–MCPæœåŠ¡ä¸å¯ç”¨');
            return;
          }
          throw fetchError;
        }
        clearTimeout(timeoutId);
        appendLog('æ”¶åˆ°åç«¯å“åº”ï¼Œæ­£åœ¨è§£ææ•°æ®...');

        if (!resp.ok) {
          appendLog(`åç«¯è¿”å›é”™è¯¯çŠ¶æ€ï¼š${resp.status}`);
          return;
        }

        const data = await resp.json();

        waypointsEl.textContent = data.waypoints
          ? JSON.stringify(data.waypoints, null, 2)
          : '// åç«¯æœªè¿”å›æ‹è§’ç‚¹ JSON';

        logsEl.textContent = data.logs || '// æ— æ—¥å¿—è¾“å‡º';
        
        // æ˜¾ç¤ºå…¬äº¤è·¯çº¿ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const transitInfoCard = document.getElementById('transitInfoCard');
        const transitInfoContent = document.getElementById('transitInfoContent');
        if (data.transit_info && selectedTransportMode === 'transit') {
          const transitInfo = data.transit_info;
          let html = '';
          
          // è·¯çº¿æè¿°
          if (transitInfo.route_description) {
            html += `<div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border-radius: 10px; border-left: 4px solid #0ea5e9;">`;
            html += `<div style="font-weight: 600; color: #0c4a6e; margin-bottom: 6px; font-size: 14px;">ğŸ“ è·¯çº¿è¯¦æƒ…</div>`;
            html += `<div style="color: #075985; line-height: 1.6; font-size: 14px;">${escapeHtml(transitInfo.route_description)}</div>`;
            html += `</div>`;
          }
          
          // è·¯çº¿æ­¥éª¤è¯¦æƒ…
          if (transitInfo.route_steps && transitInfo.route_steps.length > 0) {
            html += `<div style="margin-bottom: 16px;">`;
            html += `<div style="font-weight: 600; color: #1e293b; margin-bottom: 10px; font-size: 14px;">ğŸš¶ è¯¦ç»†æ­¥éª¤</div>`;
            transitInfo.route_steps.forEach((step, index) => {
              const stepIcon = step.type === 'walking' ? 'ğŸš¶' : step.type === 'bus' ? 'ğŸšŒ' : step.type === 'subway' ? 'ğŸš‡' : 'ğŸ“';
              html += `<div style="padding: 10px 12px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; border-left: 3px solid ${step.type === 'walking' ? '#10b981' : step.type === 'bus' ? '#3b82f6' : '#8b5cf6'};">`;
              html += `<div style="display: flex; align-items: center; gap: 8px;">`;
              html += `<span style="font-size: 18px;">${stepIcon}</span>`;
              html += `<span style="color: #334155; font-size: 14px; flex: 1;">${escapeHtml(step.description)}</span>`;
              html += `</div>`;
              html += `</div>`;
            });
            html += `</div>`;
          }
          
          // æœ€ç»ˆä¸‹è½¦ç‚¹
          if (transitInfo.final_alight_stop) {
            html += `<div style="padding: 14px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border-left: 4px solid #f59e0b;">`;
            html += `<div style="font-weight: 600; color: #92400e; margin-bottom: 6px; font-size: 14px;">ğŸ¯ æœ€ç»ˆä¸‹è½¦ç‚¹</div>`;
            html += `<div style="color: #78350f; font-size: 16px; font-weight: 600;">${escapeHtml(transitInfo.final_alight_stop.name)}</div>`;
            html += `<div style="color: #92400e; font-size: 12px; margin-top: 4px;">è¯·åœ¨æ­¤ç«™ä¸‹è½¦ï¼Œç„¶åæ­¥è¡Œå‰å¾€ç›®çš„åœ°</div>`;
            html += `</div>`;
          }
          
          // æ€»è·ç¦»å’Œæ€»æ—¶é—´
          if (transitInfo.total_distance_m || transitInfo.total_duration_s) {
            html += `<div style="margin-top: 12px; padding: 10px; background: #f1f5f9; border-radius: 8px; display: flex; gap: 20px; font-size: 13px; color: #475569;">`;
            if (transitInfo.total_distance_m) {
              html += `<div><strong>æ€»è·ç¦»ï¼š</strong>${(transitInfo.total_distance_m / 1000).toFixed(1)} å…¬é‡Œ</div>`;
            }
            if (transitInfo.total_duration_s) {
              html += `<div><strong>é¢„è®¡æ—¶é—´ï¼š</strong>${Math.round(transitInfo.total_duration_s / 60)} åˆ†é’Ÿ</div>`;
            }
            html += `</div>`;
          }
          
          transitInfoContent.innerHTML = html;
          transitInfoCard.style.display = 'block';
        } else {
          transitInfoCard.style.display = 'none';
        }
        
        // è·¯çº¿è§„åˆ’å®Œæˆåï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
        chatPoiSection.style.display = 'block';
        chatMessages.innerHTML = '';
        chatPoiButtons.style.display = 'none';
        conversationHistory = [];
        
        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯ï¼ˆåªæ˜¾ç¤ºï¼Œä¸åŠ å…¥å¯¹è¯å†å²ï¼‰
        // å› ä¸ºé€šä¹‰åƒé—®è¦æ±‚å¯¹è¯å¿…é¡»ä»¥ç”¨æˆ·æ¶ˆæ¯å¼€å§‹ï¼Œassistant æ¶ˆæ¯ä¸èƒ½ä½œä¸ºç¬¬ä¸€æ¡
        addChatMessage('assistant', 'ä½ å¥½ï¼è·¯çº¿è§„åˆ’å®Œæˆäº†ã€‚å‘Šè¯‰æˆ‘ä½ æƒ³åœ¨è·¯ä¸Šå»å“ªäº›åœ°æ–¹ï¼Œæ¯”å¦‚åƒé¥­ã€åŠ æ²¹ã€ä¼‘æ¯ç­‰ï¼Œæˆ‘ä¼šå¸®ä½ æ‰¾åˆ°æ²¿é€”åˆé€‚çš„åœ°ç‚¹ã€‚');
        
        appendLog('è·¯çº¿è§„åˆ’å®Œæˆï¼Œæ™ºèƒ½å…´è¶£ç‚¹åŠ©æ‰‹å·²å°±ç»ª');
      } catch (err) {
        console.error(err);
        appendLog(`å‰ç«¯å¼‚å¸¸ï¼š${err}`);
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'å¼€å§‹è§„åˆ’';
      }
    };
  </script>
</body>
</html>